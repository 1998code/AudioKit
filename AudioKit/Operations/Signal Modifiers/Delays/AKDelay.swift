//
//  AKDelay.swift
//  AudioKit
//
//  Autogenerated by scripts by Aurelius Prochazka. Do not edit directly.
//  Copyright (c) 2015 Aurelius Prochazka. All rights reserved.
//

import Foundation

/** Simple audio delay

Add a delay to an incoming signal with optional feedback.
*/
@objc class AKDelay : AKParameter {

    // MARK: - Properties

    private var delay = UnsafeMutablePointer<sp_delay>.alloc(1)
    private var delay2 = UnsafeMutablePointer<sp_delay>.alloc(1)

    private var input = AKParameter()

    /** Delay time, in seconds. [Default Value: 1.0] */
    private var delayTime: Float = 0


    /** Feedback amount. Should be a value between 0-1. [Default Value: 0.0] */
    var feedback: AKParameter = akp(0.0) {
        didSet {
            feedback.bind(&delay.memory.feedback, right:&delay2.memory.feedback)
            dependencies.append(feedback)
        }
    }


    // MARK: - Initializers

    /** Instantiates the delay with default values

    - parameter input: Input audio signal. 
    */
    init(input: AKParameter)
    {
        super.init()
        self.input = input
        setup()
        dependencies = [input]
        bindAll()
    }

    /** Instantiates delay with constants

    - parameter input: Input audio signal. 
    - parameter delayTime: Delay time, in seconds. [Default Value: 1.0]
    */
    init (input: AKParameter, delayTime: Float) {
        super.init()
        self.input = input
        setup(delayTime)
        dependencies = [input]
        bindAll()
    }

    /** Instantiates the delay with all values

    - parameter input: Input audio signal. 
    - parameter feedback: Feedback amount. Should be a value between 0-1. [Default Value: 0.0]
    - parameter delayTime: Delay time, in seconds. [Default Value: 1.0]
    */
    convenience init(
        input:     AKParameter,
        feedback:  AKParameter,
        delayTime: Float)
    {
        self.init(input: input, delayTime: delayTime)
        self.feedback  = feedback

        bindAll()
    }

    // MARK: - Internals

    /** Bind every property to the internal delay */
    internal func bindAll() {
        feedback .bind(&delay.memory.feedback, right:&delay2.memory.feedback)
        dependencies.append(feedback)
    }

    /** Internal set up function */
    internal func setup(delayTime: Float = 1.0) {
        sp_delay_create(&delay)
        sp_delay_create(&delay2)
        sp_delay_init(AKManager.sharedManager.data, delay, delayTime)
        sp_delay_init(AKManager.sharedManager.data, delay2, delayTime)
    }

    /** Computation of the next value */
    override func compute() {
        sp_delay_compute(AKManager.sharedManager.data, delay, &(input.leftOutput), &leftOutput);
        sp_delay_compute(AKManager.sharedManager.data, delay2, &(input.rightOutput), &rightOutput);
    }

    /** Release of memory */
    override func teardown() {
        sp_delay_destroy(&delay)
        sp_delay_destroy(&delay2)
    }
}
