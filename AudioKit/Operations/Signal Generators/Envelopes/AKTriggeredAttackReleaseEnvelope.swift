//
//  AKTriggeredAttackReleaseEnvelope.swift
//  AudioKit
//
//  Autogenerated by scripts by Aurelius Prochazka on 9/15/15.
//  Copyright (c) 2015 Aurelius Prochazka. All rights reserved.
//

import Foundation

/** Linear 2-stage Attack/Release envelope generator

This envelope takes 2 triggers. When triggered once, the envelope will rise to 1 according to the attack time. When triggered again, it will decay to 0 according to the decay time.
*/
@objc class AKTriggeredAttackReleaseEnvelope : AKParameter {

    // MARK: - Properties

    private var tenv2 = UnsafeMutablePointer<sp_tenv2>.alloc(1)

    private var trigger = AKParameter()


    /** Attack duration (in seconds). [Default Value: 0.1] */
    var attackDuration: AKParameter = akp(0.1) {
        didSet {
            attackDuration.bind(&tenv2.memory.atk)
            dependencies.append(attackDuration)
        }
    }

    /** Release duration (in seconds). [Default Value: 0.1] */
    var releaseDuration: AKParameter = akp(0.1) {
        didSet {
            releaseDuration.bind(&tenv2.memory.rel)
            dependencies.append(releaseDuration)
        }
    }


    // MARK: - Initializers

    /** Instantiates the envelope with default values

    - parameter trigger: Input trigger. 
    */
    init(trigger sourceInput: AKParameter)
    {
        super.init()
        trigger = sourceInput
        setup()
        dependencies = [trigger]
        bindAll()
    }

    /** Instantiates the envelope with all values

    - parameter trigger: Input trigger. 
    - parameter attackDuration: Attack duration (in seconds). [Default Value: 0.1]
    - parameter releaseDuration: Release duration (in seconds). [Default Value: 0.1]
    */
    convenience init(
        trigger         sourceInput: AKParameter,
        attackDuration  atkInput:    AKParameter,
        releaseDuration relInput:    AKParameter)
    {
        self.init(trigger: sourceInput)
        attackDuration  = atkInput
        releaseDuration = relInput

        bindAll()
    }

    // MARK: - Internals

    /** Bind every property to the internal envelope */
    internal func bindAll() {
        attackDuration .bind(&tenv2.memory.atk)
        releaseDuration.bind(&tenv2.memory.rel)
        dependencies.append(attackDuration)
        dependencies.append(releaseDuration)
    }

    /** Internal set up function */
    internal func setup() {
        sp_tenv2_create(&tenv2)
        sp_tenv2_init(AKManager.sharedManager.data, tenv2)
    }

    /** Computation of the next value */
    override func compute() {
        sp_tenv2_compute(AKManager.sharedManager.data, tenv2, &(trigger.leftOutput), &leftOutput);
        rightOutput = leftOutput
    }

    /** Release of memory */
    override func teardown() {
        sp_tenv2_destroy(&tenv2)
    }
}
