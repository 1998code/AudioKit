//
//  AKFlatFrequencyResponseReverb.swift
//  AudioKit
//
//  Autogenerated by scripts by Aurelius Prochazka on 9/8/15.
//  Copyright (c) 2015 Aurelius Prochazka. All rights reserved.
//

import Foundation

/** All-pass filter, often used for the creation of reverb modules.

This filter reiterates the input with an echo density determined by loop time. The attenuation rate is independent and is determined by the reverberation time (defined as the time in seconds for a signal to decay to 1/1000, or 60dB down from its original amplitude).  Output will begin to appear immediately.
*/
@objc class AKFlatFrequencyResponseReverb : AKParameter {

    // MARK: - Properties

    private var allpass = UnsafeMutablePointer<sp_allpass>.alloc(1)
    private var input = AKParameter()

    /** The loop duration of the filter, in seconds. This can also be thought of as the delay time or “echo density” of the reverberation. [Default Value: 0.1] */
    private var loopDuration: Float = 0


    /** The duration in seconds for a signal to decay to 1/1000, or 60dB down from its original amplitude. [Default Value: 0.5] */
    var reverbDuration: AKParameter = akp(0.5) {
        didSet { reverbDuration.bind(&allpass.memory.revtime) }
    }


    // MARK: - Initializers

    /** Instantiates the reverb with default values */
    init(input source: AKParameter)

    {
        super.init()
        input = source
        setup()
        bindAll()
    }

    /**
    Instantiates reverb with constants

    :param: loopDuration The loop duration of the filter, in seconds. This can also be thought of as the delay time or “echo density” of the reverberation. [Default Value: 0.1]
 */
    init (input source: AKParameter, loopDuration looptime: Float) {
        super.init()
        input = source
        setup(loopDuration: looptime)
        bindAll()
    }

    /**
    Instantiates the reverb with all values

    :param: input Input audio signal. 
    :param: reverbDuration The duration in seconds for a signal to decay to 1/1000, or 60dB down from its original amplitude. [Default Value: 0.5]
    :param: loopDuration The loop duration of the filter, in seconds. This can also be thought of as the delay time or “echo density” of the reverberation. [Default Value: 0.1]
    */
    convenience init(
        input          source:   AKParameter,
        reverbDuration revtime:  AKParameter,
        loopDuration   looptime: Float)
    {
        self.init(input: source, 
loopDuration: looptime)

        reverbDuration = revtime

        bindAll()
    }

    // MARK: - Internals

    /** Bind every property to the internal reverb */
    internal func bindAll() {
        reverbDuration.bind(&allpass.memory.revtime)
    }

    /** Internal set up function */
    internal func setup(loopDuration: Float = 0.1)
 {
        sp_allpass_create(&allpass)
        sp_allpass_init(AKManager.sharedManager.data, allpass, loopDuration)
    }

    /** Computation of the next value */
    override func compute() -> Float {
        sp_allpass_compute(AKManager.sharedManager.data, allpass, &(input.value), &value);
        pointer.memory = value
        return value
    }

    /** Release of memory */
    override func teardown() {
        sp_allpass_destroy(&allpass)
    }
}
