//
//  AKRingModulator.swift
//  AudioKit
//
//  Autogenerated by scripts by Aurelius Prochazka. Do not edit directly.
//  Copyright (c) 2016 Aurelius Prochazka. All rights reserved.
//

import AVFoundation

/// AudioKit version of Apple's Ring Modulator from the Distortion Audio Unit
///
/// - parameter input: Input node to process
/// - parameter frequency1: Frequency1 (Hertz) ranges from 0.5 to 8000 (Default: 100)
/// - parameter frequency2: Frequency2 (Hertz) ranges from 0.5 to 8000 (Default: 100)
/// - parameter balance: Balance (Percent) ranges from 0 to 100 (Default: 50)
/// - parameter mix: Mix (Percent) ranges from 0 to 100 (Default: 100)
///
public class AKRingModulator: AKNode, AKToggleable {

    private let cd = AudioComponentDescription(
        componentType: kAudioUnitType_Effect,
        componentSubType: kAudioUnitSubType_Distortion,
        componentManufacturer: kAudioUnitManufacturer_Apple,
        componentFlags: 0,
        componentFlagsMask: 0)

    internal var internalEffect = AVAudioUnitEffect()
    internal var internalAU = AudioUnit()

    /// Required property for AKNode containing the output node
    public var avAudioNode: AVAudioNode

    /// Required property for AKNode containing all the node's connections
    public var connectionPoints = [AVAudioConnectionPoint]()
    
    private var lastKnownMix: Double = 100
        
    /// Frequency1 (Hertz) ranges from 0.5 to 8000 (Default: 100)
    public var frequency1: Double = 100 {
        didSet {
            if frequency1 < 0.5 {
                frequency1 = 0.5
            }
            if frequency1 > 8000 {
                frequency1 = 8000
            }
            AudioUnitSetParameter(internalAU, kDistortionParam_RingModFreq1, kAudioUnitScope_Global, 0, Float(frequency1), 0)
        }
    }
    
    /// Frequency2 (Hertz) ranges from 0.5 to 8000 (Default: 100)
    public var frequency2: Double = 100 {
        didSet {
            if frequency2 < 0.5 {
                frequency2 = 0.5
            }
            if frequency2 > 8000 {
                frequency2 = 8000
            }
            AudioUnitSetParameter(internalAU, kDistortionParam_RingModFreq2, kAudioUnitScope_Global, 0, Float(frequency2), 0)
        }
    }
    
    /// Ring Mod Balance (Percent) ranges from 0 to 100 (Default: 50)
    public var balance: Double = 50 {
        didSet {
            if balance < 0 {
                balance = 0
            }
            if balance > 100 {
                balance = 100
            }
            AudioUnitSetParameter(internalAU, kDistortionParam_RingModBalance, kAudioUnitScope_Global, 0, Float(balance), 0)
        }
    }
    
    /// Mix (Percent) ranges from 0 to 100 (Default: 100)
    public var mix: Double = 100 {
        didSet {
            if mix < 0 {
                mix = 0
            }
            if mix > 100 {
                mix = 100
            }
            AudioUnitSetParameter(internalAU, kDistortionParam_FinalMix, kAudioUnitScope_Global, 0, Float(mix), 0)
        }
    }
    
    
    /// Tells whether the node is processing (ie. started, playing, or active)
    public var isStarted = true
    
    /// Initialize the ring modulator node
    ///
    /// - parameter input: Input node to process
    /// - parameter frequency1: Frequency1 (Hertz) ranges from 0.5 to 8000 (Default: 100)
    /// - parameter frequency2: Frequency2 (Hertz) ranges from 0.5 to 8000 (Default: 100)
    /// - parameter balance: Balance (Percent) ranges from 0 to 100 (Default: 50)
    /// - parameter mix: Mix (Percent) ranges from 0 to 100 (Default: 100)
    ///
    public init(
        var _ input: AKNode,
        frequency1: Double = 100,
        frequency2: Double = 100,
        balance: Double = 50,
        mix: Double = 100) {
            
            self.frequency1 = frequency1
            self.frequency2 = frequency2
            self.balance = balance
            self.mix = mix
            
            internalEffect = AVAudioUnitEffect(audioComponentDescription: cd)
            self.avAudioNode = internalEffect
            AKManager.sharedInstance.engine.attachNode(self.avAudioNode)
            input.addConnectionPoint(self)
            internalAU = internalEffect.audioUnit

            // Since this is the Ring Modulator, mix it to 100% and use the final mix as the mix parameter
            AudioUnitSetParameter(internalAU, kDistortionParam_RingModMix, kAudioUnitScope_Global, 0, 100, 0)
            
            AudioUnitSetParameter(internalAU, kDistortionParam_RingModFreq1,   kAudioUnitScope_Global, 0, Float(frequency1), 0)
            AudioUnitSetParameter(internalAU, kDistortionParam_RingModFreq2,   kAudioUnitScope_Global, 0, Float(frequency2), 0)
            AudioUnitSetParameter(internalAU, kDistortionParam_RingModBalance, kAudioUnitScope_Global, 0, Float(balance), 0)
            AudioUnitSetParameter(internalAU, kDistortionParam_FinalMix,       kAudioUnitScope_Global, 0, Float(mix), 0)
            
    }
    
    /// Function to start, play, or activate the node, all do the same thing
    public func start() {
        if isStopped {
            mix = lastKnownMix
            isStarted = true
        }
    }
    
    /// Function to stop or bypass the node, both are equivalent
    public func stop() {
        if isPlaying {
            lastKnownMix = mix
            mix = 0
            isStarted = false
        }
    }
}
